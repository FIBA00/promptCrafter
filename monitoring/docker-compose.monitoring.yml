version: "3.8"

services:
    prometheus:
        image: prom/prometheus:v2.52.0
        container_name: prometheus
        volumes:
            - ./prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus_data:/prometheus
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
        extra_hosts:
            - "host.docker.internal:host-gateway"
        ports:
            - "9090:9090"
        networks:
            - app_network
        restart: unless-stopped

    grafana:
        image: grafana/grafana:11.1.0
        container_name: grafana
        volumes:
            - grafana_data:/var/lib/grafana
            - ./grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
            # Dashboard provisioning
            - ./grafana-dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml
            - ./fastapi_dashboard.json:/var/lib/grafana/dashboards/fastapi_dashboard.json
        environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=admin
        ports:
            - "3000:3000"
        networks:
            - app_network
        restart: unless-stopped

    postgres-exporter:
        image: prometheuscommunity/postgres-exporter:v0.15.0
        container_name: postgres-exporter
        environment:
            # This connects to the 'postgres' service defined in the main docker-compose-dev.yml
            # It uses the same credentials.
            - DATA_SOURCE_NAME=postgresql://fraold:1234fraol@postgres:5432/promptcrafter_db_local?sslmode=disable
        networks:
            - app_network
        restart: unless-stopped

volumes:
    prometheus_data:
    grafana_data:

networks:
    app_network:
        # This connects to the network defined in the main docker-compose-dev.yml
        external: true
        name: promptcrafter_app_network
