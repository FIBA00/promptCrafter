services:
    # ---------------------------------------------------------------------------
    # Core Application
    # ---------------------------------------------------------------------------
    api:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: promptcrafter_api
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        ports:
            - "8000:8000"
        # Mount source code for optional live changes, though typically 'testing before shipping'
        # implies testing the built artifact. Uncomment the next line to enable live reload:
        command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
        env_file:
            - backend/.env
        environment:
            - DATABASE_USERNAME=fraold
            - DATABASE_PASSWORD=1234fraol
            - DATABASE_HOSTNAME=postgres
            - DATABASE_PORT=5432
            - DATABASE_NAME=promptcrafter_db_local
            - REDIS_URL=redis://redis:6379
        networks:
            - app_network
        volumes:
            - ./backend:/app

    postgres:
        image: postgres:15
        container_name: promptcrafter_db
        environment:
            - POSTGRES_USER=fraold
            - POSTGRES_PASSWORD=1234fraol
            - POSTGRES_DB=promptcrafter_db_local
        volumes:
            - postgres_data:/var/lib/postgresql/data
        ports:
            - "5433:5432"
        networks:
            - app_network
        healthcheck:
            test:
                ["CMD-SHELL", "pg_isready -U fraold -d promptcrafter_db_local"]
            interval: 5s
            timeout: 5s
            retries: 5

    redis:
        image: redis:alpine
        container_name: promptcrafter_redis
        networks:
            - app_network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 5s
            retries: 5

    # ---------------------------------------------------------------------------
    # Monitoring Stack
    # ---------------------------------------------------------------------------
    prometheus:
        image: prom/prometheus:v2.52.0
        container_name: prometheus
        volumes:
            - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus_data:/prometheus
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
        ports:
            - "9090:9090"
        networks:
            - app_network
        restart: unless-stopped

    grafana:
        image: grafana/grafana:11.1.0
        container_name: grafana
        volumes:
            - grafana_data:/var/lib/grafana
            - ./monitoring/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
            - ./monitoring/grafana-dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml
            - ./monitoring/fastapi_dashboard.json:/var/lib/grafana/dashboards/fastapi_dashboard.json
        environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=admin
        ports:
            - "3000:3000"
        networks:
            - app_network
        restart: unless-stopped
        depends_on:
            - prometheus

    postgres-exporter:
        image: prometheuscommunity/postgres-exporter:v0.15.0
        container_name: postgres-exporter
        environment:
            - DATA_SOURCE_NAME=postgresql://fraold:1234fraol@postgres:5432/promptcrafter_db_local?sslmode=disable
        networks:
            - app_network
        restart: unless-stopped
        depends_on:
            postgres:
                condition: service_healthy

volumes:
    postgres_data:
    prometheus_data:
    grafana_data:

networks:
    app_network:
        driver: bridge
