services:
    api:
        build:
            context: .
            dockerfile: Dockerfile
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        ports:
            - "8000:8000"
        # Sync backend folder specifically
        volumes:
            - ./backend:/app
        # Run with reload for development
        command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
        env_file:
            - backend/.env
        environment:
            - DATABASE_USERNAME=fraold
            - DATABASE_PASSWORD=1234fraol
            - DATABASE_HOSTNAME=postgres
            - DATABASE_PORT=5432
            - DATABASE_NAME=promptcrafter_db_local
            - REDIS_URL=redis://redis:6379
        networks:
            - app_network

    postgres:
        image: postgres:15
        environment:
            - POSTGRES_USER=fraold
            - POSTGRES_PASSWORD=1234fraol
            - POSTGRES_DB=promptcrafter_db_local
        volumes:
            - postgres_data:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        networks:
            - app_network
        healthcheck:
            test:
                ["CMD-SHELL", "pg_isready -U fraold -d promptcrafter_db_local"]
            interval: 5s
            timeout: 5s
            retries: 5

    redis:
        image: redis:alpine
        ports:
            - "6379:6379"
        networks:
            - app_network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 5s
            retries: 5

volumes:
    postgres_data:

networks:
    app_network:
        driver: bridge
